<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elyx Member Dashboard</title>
    <style>
        :root {
            --bg-dark: #111827; --bg-med: #1F2937; --bg-light: #374151;
            --border-color: #4B5563; --text-light: #F3F4F6; --text-med: #9CA3AF;
            --accent: #2DD4BF; --accent-dark: #0D9488;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-dark); color: var(--text-light);
            margin: 0; display: flex;
        }
        .sidebar {
            width: 240px; background-color: var(--bg-med); padding: 1.5rem;
            height: 100vh; border-right: 1px solid var(--border-color);
            display: flex; flex-direction: column;
        }
        .sidebar-header {
            display: flex; align-items: center; gap: 0.75rem;
            margin-bottom: 2rem; font-size: 1.25rem; font-weight: bold;
        }
        .sidebar-header svg { color: var(--accent); }
        .sidebar-nav a {
            display: flex; align-items: center; gap: 0.75rem;
            padding: 0.75rem; border-radius: 0.5rem;
            text-decoration: none; color: var(--text-med);
            transition: background-color 0.2s, color 0.2s;
        }
        .sidebar-nav a:hover { background-color: var(--bg-light); color: var(--text-light); }
        .sidebar-nav a.active { background-color: var(--accent); color: var(--bg-dark); font-weight: bold; }
        .main-content { flex-grow: 1; padding: 2rem; max-height: 100vh; overflow-y: auto; }
        .page { display: none; }
        .page.active { display: block; }
        .card {
            background-color: var(--bg-med); border: 1px solid var(--border-color);
            border-radius: 0.75rem; padding: 1.5rem; margin-bottom: 1.5rem;
        }
        .grid-container { display: grid; grid-template-columns: 1fr 2fr; gap: 1.5rem; }
        .timeline-container { max-height: 75vh; overflow-y: auto; }
        .timeline-item {
            display: flex; gap: 1rem; padding: 0.75rem; border-radius: 0.5rem;
            cursor: pointer; transition: background-color 0.2s;
            border-left: 3px solid transparent;
        }
        .timeline-item:hover { background-color: var(--bg-light); }
        .timeline-item.selected { background-color: rgba(45, 212, 191, 0.1); border-left-color: var(--accent); }
        .timeline-icon {
            background-color: var(--bg-light); width: 40px; height: 40px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; flex-shrink: 0;
        }
        .timeline-item h4 { margin: 0; font-size: 0.9rem; }
        .timeline-item p, .snapshot-card p { margin: 0.25rem 0 0; font-size: 0.875rem; color: var(--text-med); }
        .decision-link { font-size: 0.75rem; color: var(--accent); font-weight: bold; margin-top: 0.25rem; }
        .snapshot-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem; }
        .snapshot-card { background-color: var(--bg-dark); padding: 1rem; border-radius: 0.5rem; }
        .snapshot-card h4 { margin: 0 0 0.5rem; color: var(--text-med); font-weight: normal; }
        .chat-container { max-height: 300px; overflow-y: auto; padding-right: 0.5rem; }
        .messages-log { display: flex; flex-direction: column; gap: 1rem; }
        .chat-bubble { display: flex; gap: 0.75rem; max-width: 80%; }
        .chat-bubble.member { align-self: flex-end; flex-direction: row-reverse; }
        .chat-bubble .avatar { width: 40px; height: 40px; border-radius: 50%; background-color: var(--bg-light); flex-shrink: 0; display: flex; align-items: center; justify-content: center; font-weight: bold;}
        .chat-bubble.member .avatar { background-color: var(--accent); color: var(--bg-dark); }
        .chat-bubble .content { background-color: var(--bg-light); padding: 0.75rem 1rem; border-radius: 0.75rem; }
        .chat-bubble.member .content { background-color: var(--accent-dark); }
        .chat-bubble .sender { font-weight: bold; font-size: 0.875rem; margin-bottom: 0.25rem; display: block;}
        .chat-bubble p { margin: 0; line-height: 1.5; }
        .profile-grid, .specialists-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.5rem; }
        .specialist-card { text-align: center; }
        .specialist-card img { width: 120px; height: 120px; border-radius: 50%; object-fit: cover; margin: 0 auto 1rem; border: 3px solid var(--border-color); }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.2); border-left-color: var(--accent);
            border-radius: 50%; width: 40px; height: 40px;
            animation: spin 1s linear infinite; margin: 5rem auto;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <aside class="sidebar">
        <div class="sidebar-header">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>
            <span>Elyx Dashboard</span>
        </div>
        <nav class="sidebar-nav">
            <a href="#journey" class="nav-link active">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 12h-4l-3 9L9 3l-3 9H2"></path></svg>
                <span>Journey</span>
            </a>
            <a href="#messages" class="nav-link">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
                <span>Messages</span>
            </a>
            <a href="#profile" class="nav-link">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                <span>Profile</span>
            </a>
            <a href="#specialists" class="nav-link">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                <span>Specialists</span>
            </a>
        </nav>
    </aside>

    <main class="main-content">
        <div id="page-journey" class="page active">
            <h1>Member Journey</h1><div class="spinner"></div>
        </div>
        <div id="page-messages" class="page">
            <h1>Full Message Log</h1><div class="spinner"></div>
        </div>
        <div id="page-profile" class="page">
            <h1>Member Profile</h1><div class="spinner"></div>
        </div>
        <div id="page-specialists" class="page">
            <h1>Your Care Team</h1><div class="spinner"></div>
        </div>
    </main>
    
    <div id="decision-modal" style="display: none;"></div>

    <script>
        const API_BASE_URL = "https://elyx-hackathon-3-2-bit.onrender.com/api";
        
        // --- Global State ---
        let appData = {
            profile: null, journey: [], messages: [], specialists: [],
            selectedEvent: null
        };

        // --- DOM Elements ---
        const pages = document.querySelectorAll('.page');
        const navLinks = document.querySelectorAll('.nav-link');

        // --- Icons (as SVG strings) ---
        const icons = {
            medication: `<svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" style="color: #F87171;"><path d="M22 12h-4l-3 9L9 3l-3 9H2"></path></svg>`,
            diagnostic: `<svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" style="color: #60A5FA;"><path d="M12 2L2 7l10 5 10-5-10-5z"></path><path d="M2 17l10 5 10-5"></path><path d="M2 12l10 5 10-5"></path></svg>`,
            travel: `<svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" style="color: #FBBF24;"><path d="M22 12h-4l-3 9L9 3l-3 9H2"></path></svg>`,
            plan: `<svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24" style="color: #34D399;"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"></path></svg>`,
            default: `<svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"></path></svg>`
        };

        // --- Router ---
        const router = () => {
            const hash = window.location.hash || '#journey';
            pages.forEach(page => page.classList.remove('active'));
            navLinks.forEach(link => link.classList.remove('active'));
            
            const activePage = document.getElementById(`page-${hash.substring(1)}`);
            const activeLink = document.querySelector(`a[href="${hash}"]`);

            if (activePage) activePage.classList.add('active');
            if (activeLink) activeLink.classList.add('active');
        };

        // --- Render Functions for Each Page ---
        const renderJourneyPage = () => {
            const container = document.getElementById('page-journey');
            if (!appData.journey.length) return;
            appData.selectedEvent = appData.selectedEvent || appData.journey[0];
            
            const timelineHtml = appData.journey.map(event => `
                <div class="timeline-item ${appData.selectedEvent.date === event.date ? 'selected' : ''}" data-date="${event.date}">
                    <div class="timeline-icon">${icons[event.type] || icons.default}</div>
                    <div>
                        <h4>${event.title}</h4>
                        <p>${new Date(event.date).toLocaleDateString('en-US', { month: 'long', day: 'numeric' })}</p>
                        ${event.decision_id ? `<div class="decision-link" data-decision-id="${event.decision_id}">Why this decision?</div>` : ''}
                    </div>
                </div>`).join('');

            container.innerHTML = `
                <h1>Member Journey</h1>
                <div class="grid-container">
                    <div class="card"><div class="timeline-container">${timelineHtml}</div></div>
                    <div class="card" id="snapshot-container"><div class="spinner"></div></div>
                </div>`;
            renderSnapshot();

            // Add event listeners after rendering
            container.querySelectorAll('.timeline-item').forEach(item => {
                item.addEventListener('click', () => {
                    appData.selectedEvent = appData.journey.find(e => e.date === item.dataset.date);
                    renderJourneyPage();
                });
            });
            container.querySelectorAll('.decision-link').forEach(link => {
                link.addEventListener('click', e => { e.stopPropagation(); /* Logic for modal */ });
            });
        };
        
        const renderMessagesPage = () => {
            const container = document.getElementById('page-messages');
            if (!appData.messages.length) return;
            const messagesHtml = appData.messages.map(msg => `
                <div class="chat-bubble ${msg.sender_id.includes('member') ? 'member' : ''}">
                    <div class="avatar">${msg.sender_name.substring(0, 1)}</div>
                    <div class="content">
                        <span class="sender">${msg.sender_name} - ${new Date(msg.timestamp).toLocaleString()}</span>
                        <p>${msg.content}</p>
                    </div>
                </div>
            `).join('');
            container.innerHTML = `<h1>Full Message Log</h1><div class="messages-log">${messagesHtml}</div>`;
        };

        const renderProfilePage = () => {
            const container = document.getElementById('page-profile');
            if (!appData.profile) return;
            container.innerHTML = `
                <h1>Member Profile</h1>
                <div class="card">
                    <h2>${appData.profile.name}</h2>
                    <p><strong>Age:</strong> ${appData.profile.age}</p>
                    <p><strong>Occupation:</strong> ${appData.profile.occupation}</p>
                    <p><strong>Condition:</strong> ${appData.profile.chronic_condition}</p>
                </div>`;
        };
        
        const renderSpecialistsPage = () => {
            const container = document.getElementById('page-specialists');
            if (!appData.specialists.length) return;
            const specialistsHtml = appData.specialists.map(sp => `
                <div class="card specialist-card">
                    <img src="${sp.image_url}" alt="${sp.name}">
                    <h3>${sp.name}</h3>
                    <h4>${sp.role}</h4>
                    <p><em>${sp.specialty}</em></p>
                    <p>${sp.bio}</p>
                </div>`).join('');
            container.innerHTML = `<h1>Your Care Team</h1><div class="specialists-grid">${specialistsHtml}</div>`;
        };

        const renderSnapshot = async () => {
            const container = document.getElementById('snapshot-container');
            if (!container || !appData.selectedEvent) return;
            container.innerHTML = `<div class="spinner"></div>`;
            const dateStr = new Date(appData.selectedEvent.date).toISOString();
            const response = await fetch(`${API_BASE_URL}/snapshot?date=${dateStr}`);
            const data = await response.json();
            
            const commsHtml = data.communications.length > 0 ? data.communications.map(msg => `
                <div class="chat-bubble" style="max-width: 100%;">
                    <div class="avatar">${msg.sender_name.substring(0,1)}</div>
                    <div class="content">
                      <span class="sender">${msg.sender_name}</span>
                      <p>${msg.content}</p>
                    </div>
                </div>`).join('') : '<p>No communications on this day.</p>';

            container.innerHTML = `
                <h3>Snapshot for ${new Date(appData.selectedEvent.date).toLocaleDateString('en-US', { month: 'long', day: 'numeric' })}</h3>
                <p>Status on the day of: <strong>"${appData.selectedEvent.title}"</strong></p>
                <div class="snapshot-grid">
                    <div class="snapshot-card"><h4>Active Plan</h4><p>${data.activePlan}</p></div>
                    <div class="snapshot-card"><h4>Medications</h4><p>${data.activeMedications}</p></div>
                </div>
                <h3 style="margin-top: 1.5rem;">Communications on this Day</h3>
                <div class="chat-container">${commsHtml}</div>`;
        };

        // --- Initialization ---
        const initializeApp = async () => {
            try {
                const [profileRes, journeyRes, messagesRes, specialistsRes] = await Promise.all([
                    fetch(`${API_BASE_URL}/profile`), fetch(`${API_BASE_URL}/journey`),
                    fetch(`${API_BASE_URL}/messages`), fetch(`${API_BASE_URL}/specialists`)
                ]);
                appData.profile = await profileRes.json();
                appData.journey = await journeyRes.json();
                appData.messages = await messagesRes.json();
                appData.specialists = await specialistsRes.json();

                // Render all pages with the fetched data
                renderJourneyPage();
                renderMessagesPage();
                renderProfilePage();
                renderSpecialistsPage();
                
                // Set the initial page based on the URL hash
                router();
            } catch (error) {
                console.error("Failed to initialize app:", error);
                document.querySelector('.main-content').innerHTML = `<h1>Error: Could not connect to the backend.</h1>`;
            }
        };

        window.addEventListener('hashchange', router);
        document.addEventListener('DOMContentLoaded', initializeApp);

    </script>
</body>
</html>
