<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Elyx Health Journey</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />

    <style>
        /* Global styles and custom spinner for loading indicators */
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            background-color: #f3f4f6; /* Gray 100 */
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #4f46e5; /* Indigo 600 */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 2rem auto;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <noscript>You need to enable JavaScript to run this app.</noscript>
    <div id="root"></div>

    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="text/babel">
        // All JavaScript/React code goes here.

        const { useState, useEffect, useCallback, useRef } = React;

        // --- NavItem Component ---
        const NavItem = ({ label, section, activeSection, setActiveSection }) => {
            return (
                <button
                    className={`px-4 py-2 rounded-md text-sm font-medium transition-colors duration-200 ${
                        activeSection === section 
                        ? 'bg-indigo-700 text-white shadow-md' 
                        : 'text-indigo-100 hover:bg-indigo-500 hover:bg-opacity-75'
                    }`}
                    onClick={() => setActiveSection(section)}
                >
                    {label}
                </button>
            );
        };

        // --- Main App Component ---
        function App() {
            // --- STATE MANAGEMENT ---
            const [activeSection, setActiveSection] = useState('journey');
            const [journeyData, setJourneyData] = useState([]);
            const [isLoading, setIsLoading] = useState(true);
            const [error, setError] = useState(null);
            const [decisionQuery, setDecisionQuery] = useState('');
            const [decisionResponse, setDecisionResponse] = useState('');
            const [isLoadingDecision, setIsLoadingDecision] = useState(false);


            // --- IMPORTANT: Backend Configuration ---
            // Update this URL if your backend is running on a different address or is deployed.
            const BACKEND_API_URL = "http://127.0.0.1:5001";

            // --- DATA FETCHING ---
            const fetchJourneyData = useCallback(async () => {
                setIsLoading(true);
                setError(null);
                try {
                    // CORRECTED: Use GET method and the /api/journey endpoint
                    const response = await fetch(`${BACKEND_API_URL}/api/journey`);
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}. Is the backend server running?`);
                    }
                    const data = await response.json();
                    const sortedData = data.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                    setJourneyData(sortedData);
                } catch (err) {
                    console.error("Failed to fetch journey data:", err);
                    setError(err.message);
                    setJourneyData([]); // Clear data on error
                } finally {
                    setIsLoading(false);
                }
            }, []);

            // --- DECISION QUERY ---
            const handleDecisionQuery = async () => {
                 if (!decisionQuery.trim()) {
                    setDecisionResponse("Please enter a question about a decision.");
                    return;
                }
                setIsLoadingDecision(true);
                setDecisionResponse("Thinking...");
                try {
                    const response = await fetch(`${BACKEND_API_URL}/api/explain-decision`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ query: decisionQuery, journeyData: journeyData }),
                    });
                    const data = await response.json();
                    if (response.ok) {
                        setDecisionResponse(data.explanation);
                    } else {
                        setDecisionResponse(`Error from backend: ${data.error || 'Unknown error'}`);
                    }
                } catch (error) {
                    setDecisionResponse("An error occurred. Please ensure the backend is running.");
                } finally {
                    setIsLoadingDecision(false);
                }
            };
            
            // Fetch data when the component first loads
            useEffect(() => {
                fetchJourneyData();
            }, [fetchJourneyData]);
            
            // --- UI RENDER LOGIC ---

            const renderContent = () => {
                if (isLoading) {
                    return <div className="text-center p-10"><div className="spinner"></div><p className="text-lg text-gray-600 mt-4">Generating Health Journey...</p></div>;
                }
                if (error) {
                    return <div className="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-md shadow-lg" role="alert">
                        <p className="font-bold">Error Fetching Data</p>
                        <p>{error}</p>
                        <p className="mt-2 text-sm">Please make sure your Python backend server (`llm_service.py`) is running and the URL is correct.</p>
                    </div>;
                }
                switch (activeSection) {
                    case 'journey':
                        return <JourneyTimeline data={journeyData} onRefresh={fetchJourneyData} isLoading={isLoading} />;
                    case 'messages':
                        return <MessagesView data={journeyData} onRefresh={fetchJourneyData} isLoading={isLoading} />;
                    case 'decision-query':
                        return <DecisionQueryView />;
                    default:
                        return <div className="text-center p-10"><h2 className="text-2xl font-bold">Welcome to Elyx</h2><p>Select a view to begin.</p></div>;
                }
            };
            
            // --- UI COMPONENTS ---
            const JourneyTimeline = ({ data, onRefresh, isLoading }) => (
                <div className="bg-white p-6 md:p-8 rounded-lg shadow-md border border-gray-200">
                     <div className="flex justify-between items-center mb-6">
                        <h2 className="text-2xl font-bold text-gray-800">Health Journey Timeline</h2>
                        <button 
                            onClick={onRefresh}
                            className="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-indigo-700 transition-all duration-300 disabled:opacity-50"
                            disabled={isLoading}
                        >
                            {isLoading ? 'Refreshing...' : 'Refresh Journey'}
                        </button>
                    </div>
                    <div className="relative pl-6 border-l-2 border-indigo-200 max-h-[70vh] overflow-y-auto pr-4">
                        {data.map((item, index) => {
                             const isRohan = item.sender === 'Rohan';
                             const isSystem = item.sender === 'System';
                             let icon = 'üí¨'; // Default for team
                             if (isRohan) icon = 'üë§';
                             if (isSystem) icon = '‚öôÔ∏è';
                             if (item.type && item.type.includes('diagnostic')) icon = 'üî¨';
                             if (item.type && item.type.includes('travel')) icon = '‚úàÔ∏è';
                             if (item.type && item.type.includes('exercise')) icon = 'üèãÔ∏è';

                             return (
                                <div key={index} className="mb-8 relative">
                                    <div className={`absolute -left-8 top-1 w-10 h-10 bg-white border-2 ${isSystem ? 'border-gray-400' : 'border-indigo-500'} rounded-full flex items-center justify-center text-xl z-10`}>
                                        {icon}
                                    </div>
                                    <div className="ml-6">
                                        <p className="text-sm text-gray-500 mb-1">{item.timestamp}</p>
                                        <p className={`font-semibold text-lg ${isRohan ? 'text-blue-600' : 'text-gray-800'}`}>
                                            {item.sender}:
                                        </p>
                                        <p className="text-gray-700 leading-relaxed">{item.content}</p>
                                        {item.specialist && !isSystem && (
                                            <p className="mt-2 text-xs text-white bg-indigo-400 rounded-full px-2 py-0.5 inline-block">
                                                Specialist: {item.specialist}
                                            </p>
                                        )}
                                        {item.decisionRationale && (
                                            <div className="mt-2 p-3 bg-blue-50 rounded-md border border-blue-200 text-blue-800 text-sm">
                                                <p className="font-medium">Rationale:</p>
                                                <p>{item.decisionRationale}</p>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                </div>
            );

            const MessagesView = ({ data, onRefresh, isLoading }) => {
                const messages = data.filter(item => item.type === 'message' || item.type.includes('update'));
                return (
                    <div className="bg-white p-4 sm:p-6 rounded-lg shadow-md border border-gray-200">
                        <div className="flex justify-between items-center mb-4">
                            <h2 className="text-2xl font-bold text-gray-800">Conversations</h2>
                            <button 
                                onClick={onRefresh}
                                className="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-indigo-700 transition-all duration-300 disabled:opacity-50"
                                disabled={isLoading}
                            >
                                {isLoading ? 'Refreshing...' : 'Refresh Journey'}
                            </button>
                        </div>
                        <div className="h-[70vh] overflow-y-auto flex flex-col-reverse p-4 bg-gray-50 rounded-lg">
                            <div className="space-y-4">
                                {messages.slice().reverse().map((msg, index) => {
                                    const isRohan = msg.sender === 'Rohan';
                                    return (
                                        <div key={index} className={`flex items-end gap-3 ${isRohan ? 'justify-end' : 'justify-start'}`}>
                                            <div className={`p-3 rounded-xl max-w-lg ${isRohan ? 'bg-blue-500 text-white rounded-br-none' : 'bg-gray-200 text-gray-800 rounded-bl-none'}`}>
                                                <p className="font-bold text-sm mb-1">{msg.sender}</p>
                                                <p>{msg.content}</p>
                                                <p className={`text-xs mt-2 opacity-70 ${isRohan ? 'text-blue-100' : 'text-gray-500'}`}>{msg.timestamp}</p>
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                    </div>
                );
            };

            const DecisionQueryView = () => (
                <div className="p-6 text-gray-700">
                    <h2 className="text-3xl font-semibold mb-4">Ask About a Decision</h2>
                    <p className="text-lg mb-6">Have a question about a specific recommendation, medication, or plan change? Type it below and our AI will provide the rationale.</p>
                    <div className="bg-white p-6 rounded-lg shadow-md">
                        <textarea
                            className="w-full p-4 border border-gray-300 rounded-lg mb-4 focus:ring-2 focus:ring-indigo-500 focus:border-transparent outline-none transition-all duration-200"
                            rows="5"
                            placeholder="E.g., Why was the blue-light blocking glasses suggested?"
                            value={decisionQuery}
                            onChange={(e) => setDecisionQuery(e.target.value)}
                            disabled={isLoadingDecision}
                        />
                        <button
                            className={`w-full bg-indigo-600 text-white py-3 px-6 rounded-lg font-semibold text-lg shadow-md transition-all duration-300 ${isLoadingDecision ? 'opacity-70 cursor-not-allowed' : 'hover:bg-indigo-700 hover:shadow-lg'}`}
                            onClick={handleDecisionQuery}
                            disabled={isLoadingDecision}
                        >
                            {isLoadingDecision ? 'Asking AI...' : 'Ask Elyx AI'}
                        </button>
                        {decisionResponse && (
                            <div className="mt-6 p-4 bg-indigo-50 rounded-lg border border-indigo-200 text-indigo-800 break-words whitespace-pre-wrap">
                                <p className="font-semibold">Elyx AI's Explanation:</p>
                                <p>{decisionResponse}</p>
                            </div>
                        )}
                    </div>
                </div>
            );

            // --- MAIN RENDER ---
            return (
                <div className="min-h-screen bg-gray-100 font-sans text-gray-900">
                    <nav className="bg-indigo-600 shadow-lg">
                        <div className="container mx-auto px-4 sm:px-6 lg:px-8">
                            <div className="flex items-center justify-between h-16">
                                <div className="flex items-center">
                                    <span className="text-white text-2xl font-bold">Elyx Life</span>
                                </div>
                                <div className="flex space-x-2">
                                    <NavItem label="Journey" section="journey" activeSection={activeSection} setActiveSection={setActiveSection} />
                                    <NavItem label="Messages" section="messages" activeSection={activeSection} setActiveSection={setActiveSection} />
                                    <NavItem label="Decision Query" section="decision-query" activeSection={activeSection} setActiveSection={setActiveSection} />
                                </div>
                            </div>
                        </div>
                    </nav>
                    <main className="container mx-auto px-4 py-8">
                        {renderContent()}
                    </main>
                    <footer className="bg-indigo-600 p-4 text-white text-center text-sm mt-8">
                        <p>¬© {new Date().getFullYear()} Elyx Life. All rights reserved.</p>
                    </footer>
                </div>
            );
        }

        // --- Render the App ---
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
